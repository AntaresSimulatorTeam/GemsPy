# Copyright (c) 2024, RTE (https://www.rte-france.com)
#
# See AUTHORS.txt
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# SPDX-License-Identifier: MPL-2.0
#
# This file is part of the Antares project.

# Library of models for the emulation of PyPSA
# References for PyPSA
# T. Brown, J. HÃ¶rsch, D. Schlachtberger, PyPSA: Python for Power System Analysis, 2018, Journal of Open Research Software, 6(1), arXiv:1707.09913, DOI:10.5334/jors.188
# https://pypsa.readthedocs.io/en/latest/

library:
  id: pypsa_models
  description: PyPSA model library 
  #https://pypsa.readthedocs.io/en/latest/user-guide/components.html#

  port-types:
    - id: flow
      description: A port which transfers power flow
      fields:
        - id: flow
    - id: emission
      description: A port which accounts for CO2 emissions
      fields:
        - id: emission

  models:
    - id: bus
    #Model for PyPSA bus: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#bus
      parameters:
        - id: v_nom
          time-dependent: false
          scenario-dependent: false
        #- id: type #Parameter not instantiated for now
        - id: x
          time-dependent: false
          scenario-dependent: false
        - id: y
          time-dependent: false
          scenario-dependent: false
        #- id : carrier #Parameter not instantiated for now
        #- id : unit #Parameter not instantiated for now
        #- id : location #Parameter not instantiated for now
        - id: v_mag_pu_set
          time-dependent: true
          scenario-dependent: false
        - id: v_mag_pu_min
          time-dependent: false
          scenario-dependent: false
        - id: v_mag_pu_max
          time-dependent: false
          scenario-dependent: false
      ports:
        - id: p_balance_port
          type: flow
        - id: q_balance_port
          type: flow
      binding-constraints:
        - id: p_balance
          expression: sum_connections(p_balance_port.flow) = 0
        - id: q_balance
          expression: sum_connections(q_balance_port.flow) = 0
    
    - id: load
      #Model for PyPSA load: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#load
      parameters:
        #- id : carrier #Parameter not instantiated for now
        #- id : type #Parameter not instantiated for now
        - id: p_set
          time-dependent: true
          scenario-dependent: true
        - id: q_set
          time-dependent: true
          scenario-dependent: true
        - id: sign #default value = -1
          time-dependent: false
          scenario-dependent: false
        - id: active
          time-dependent: false
          scenario-dependent: false
      ports:
        - id: p_balance_port
          type: flow
        - id: q_balance_port
          type: flow
      port-field-definitions:
        - port: p_balance_port
          field: flow
          definition: sign * p_set
        - port: q_balance_port
          field: flow
          definition: sign * q_set

    - id: generator_v0
    #Temporary (v0) model for PyPSA generator: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#generator
    #to be completed with the exhaustive list of parameters, including parameters not instantiated for now
      parameters:
        - id: p_nom
          time-dependent: false
          scenario-dependent: false
        - id: marginal_cost
          time-dependent: true
          scenario-dependent: false
      variables:
        - id: p
          lower-bound: 0
          upper-bound: p_nom
        #- id: q
      ports:
        - id: p_balance_port
          type: flow
        #- id: q_balance_port
        #  type: flow
      port-field-definitions:
        - port: p_balance_port
          field: flow
          definition: p
        #- port: q_balance_port
        #  field: flow
        #  definition: q
      objective: expec(sum(marginal_cost * p))

    - id: generator
    #Model for PyPSA generator: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#generator
      parameters:
        #- id: control #Parameter not instantiated for now
        #- id: type #Parameter not instantiated for now
        - id: p_nom
          time-dependent: false
          scenario-dependent: false
        #- id: p_nom_mod #Parameter not instantiated for now
        #- id: p_nom_extendable #Parameter not instantiated for now
        #- id: p_nom_min #Parameter not instantiated for now
        #- id: p_nom_max #Parameter not instantiated for now
        - id: p_min_pu
          time-dependent: true
          scenario-dependent: false
        - id: p_max_pu
          time-dependent: true
          scenario-dependent: false
        #- id: p_set #Parameter not instantiated for now
        #- id: q_set #Parameter not instantiated for now
        - id: e_sum_min
          time-dependent: false
          scenario-dependent: false
        - id: e_sum_max
          time-dependent: false
          scenario-dependent: false
        - id: sign #default value = 1
          time-dependent: false
          scenario-dependent: false
        #- id: carrier #Parameter not instantiated for now
        - id: marginal_cost
          time-dependent: true
          scenario-dependent: false
        #- id: marginal_cost_quadratic #Parameter not instantiated for now
        #- id: active #Parameter not instantiated for now
        #- id: build_year #Parameter not instantiated for now
        #- id: lifetime #Parameter not instantiated for now
        #- id: capital_cost #Parameter not instantiated for now
        #- id: efficiency #Parameter not instantiated for now
        #- id: committable #Parameter not instantiated for now
        #- id: start_up_cost #Parameter not instantiated for now
        #- id: shut_down_cost #Parameter not instantiated for now
        #- id: stand_by_cost #Parameter not instantiated for now
        #- id: min_up_time #Parameter not instantiated for now
        #- id: min_down_time #Parameter not instantiated for now
        #- id: up_time_before #Parameter not instantiated for now
        #- id: down_time_before #Parameter not instantiated for now
        #- id: ramp_limit_up #Parameter not instantiated for now
        #- id: ramp_limit_down #Parameter not instantiated for now
        #- id: ramp_limit_start_up #Parameter not instantiated for now
        #- id: ramp_limit_shut_down #Parameter not instantiated for now
        #- id: weight #Parameter not instantiated for now
      variables:
        - id: p
          lower-bound: p_nom*p_min_pu
          upper-bound: p_nom*p_max_pu
        #- id: q
      ports:
        - id: p_balance_port
          type: flow
        #- id: q_balance_port
        #  type: flow
      port-field-definitions:
        - port: p_balance_port
          field: flow
          definition: p*sign
        #- port: q_balance_port
        #  field: flow
        #  definition: q*sign
      constraints:
      - id: min_production
        expression: sum(p) >= e_sum_min
      - id: max_production
        expression: sum(p) <= e_sum_max
      objective: expec(sum(marginal_cost * p))

    
    - id: link
    #Model for PyPSA link: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#link
      parameters:
        #- id: type #Parameter not instantiated for now
        #- id: carrier #Parameter not instantiated for now
        - id: efficiency
          time-dependent: true
          scenario-dependent: false
        - id: active
          time-dependent: false
          scenario-dependent: false
        #- id: build_year #Parameter not instantiated for now
        #- id: lifetime #Parameter not instantiated for now
        - id: p_nom
          time-dependent: false
          scenario-dependent: false
        #- id: p_nom_mod
        #- id: p_nom_extendable #Parameter not instantiated for now
        #- id: p_nom_min #Parameter not instantiated for now
        #- id: p_nom_max #Parameter not instantiated for now
        #- id: p_set #Parameter not instantiated for now
        - id: p_min_pu
          time-dependent: true
          scenario-dependent: false
        - id: p_max_pu
          time-dependent: true
          scenario-dependent: false
        #- id: capital_cost #Parameter not instantiated for now
        - id: marginal_cost
          time-dependent: true
          scenario-dependent: false
        #- id: marginal_cost_quadratic #Parameter not instantiated for now
        #- id: stand_by_cost #Parameter not instantiated for now
        #- id: length #Parameter not instantiated for now
        #- id: terrain_factor #Parameter not instantiated for now
        #- id: committable #Parameter not instantiated for now
        #- id: start_up_cost #Parameter not instantiated for now
        #- id: shut_down_cost #Parameter not instantiated for now
        #- id: min_up_time #Parameter not instantiated for now
        #- id: min_down_time #Parameter not instantiated for now
        #- id: up_time_before #Parameter not instantiated for now
        #- id: down_time_before #Parameter not instantiated for now
        #- id: ramp_limit_up #Parameter not instantiated for now
        #- id: ramp_limit_down #Parameter not instantiated for now
        #- id: ramp_limit_start_up #Parameter not instantiated for now
        #- id: ramp_limit_shut_down #Parameter not instantiated for now
      variables:
        - id: p0
          lower-bound: p_min_pu*p_nom
          upper-bound: p_max_pu*p_nom
        - id: p1
        #- id: p_nom_opt
        #- id: status
        #- id: start_up
        #- id: shut_down
      ports:
        - id: p0_port
          type: flow
        #- id: q_0_port
        #  type: flow
        - id: p1_port
          type: flow
        #- id: q_1_port
        #  type: flow
      port-field-definitions:
        - port: p0_port
          field: flow
          definition: -p0
        - port: p1_port
          field: flow
          definition: -p1
        #- port: q_balance_port
        #  field: flow
        #  definition: q
      constraints:
        - id: balance
          expression: p1 = - efficiency * p0
      objective: expec(sum(marginal_cost * p0))

  
    - id: storage_unit
     #Model for PyPSA storage unit: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#storage-unit
      parameters:
          #- id: control #Parameter not instantiated for now
          #- id: type #Parameter not instantiated for now
        - id: p_nom
          time-dependent: false
          scenario-dependent: false
        #- id: p_nom_mod
        #- id: p_nom_extendable #Parameter not instantiated for now
        #- id: p_nom_min #Parameter not instantiated for now
        #- id: p_nom_max #Parameter not instantiated for now
        - id: p_min_pu
          time-dependent: true
          scenario-dependent: false
        - id: p_max_pu
          time-dependent: true
          scenario-dependent: false
        #- id: p_set #Parameter not instantiated for now
        #- id: q_set #Parameter not instantiated for now
        - id: sign #default value = 1
          time-dependent: false
          scenario-dependent: false
        #- id: carrier #Parameter not instantiated for now
        - id: spill_cost #Parameter not instantiated for now
          time-dependent: true
          scenario-dependent: false
        - id: marginal_cost
          time-dependent: true
          scenario-dependent: false
        #- id: marginal_cost_quadratic #Parameter not instantiated for now
        - id: marginal_cost_storage 
          time-dependent: true
          scenario-dependent: false
        #- id: capital_cost #Parameter not instantiated for now
        - id: active
          time-dependent: false
          scenario-dependent: false
        #- id: build_year #Parameter not instantiated for now
        #- id: lifetime #Parameter not instantiated for now
        #- id: state_of_charge_initial #Parameter not instantiated for now
        #- id: state_of_charge_initial_per_period #Parameter not instantiated for now
        #- id: state_pf_charge_set #Parameter not instantiated for now
        #- id: cyclic_state_of_charge #Parameter not instantiated for now
        #- id: cyclic_state_of_charge_per_period #Parameter not instantiated for now
        - id: max_hours
          time-dependent: false
          scenario-dependent: false
        - id: efficiency_store
          time-dependent: true
          scenario-dependent: false
        - id: efficiency_dispatch
          time-dependent: true
          scenario-dependent: false
        - id: standing_loss
          time-dependent: true
          scenario-dependent: false
        - id: inflow
          time-dependent: true
          scenario-dependent: true
      variables:
        - id: p_store
          lower-bound: 0
          upper-bound: p_max_pu*p_nom
        - id: p_dispatch
          lower-bound: 0
          upper-bound: p_max_pu*p_nom
        - id: state_of_charge
          lower-bound: 0
          upper-bound: max_hours*p_nom
        - id: spill
          lower-bound: 0
      ports:
        - id: p_balance_port
          type: flow
      port-field-definitions:
        - port: p_balance_port
          field: flow
          definition: p_dispatch - p_store
      constraints:
        - id: state_of_charge_balance
          expression: state_of_charge = (1- standing_loss) * state_of_charge[t-1] + efficiency_store * p_store - p_dispatch / efficiency_dispatch  + inflow - spill
      objective: expec(sum(marginal_cost * p_dispatch + spill_cost*spill + marginal_cost_storage * state_of_charge))

    - id: store
      #Model for PyPSA store: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#store
      parameters:
        #- id: type #Parameter not instantiated for now
        #- id: carrier #Parameter not instantiated for now
        - id: e_nom
          time-dependent: false
          scenario-dependent: false
        #- id: e_nom_mod #Parameter not instantiated for now
        - id: e_nom_extendable
          time-dependent: false
          scenario-dependent: false
        - id: e_nom_min
          time-dependent: false
          scenario-dependent: false
        - id: e_nom_max
          time-dependent: false
          scenario-dependent: false
        - id: e_min_pu
          time-dependent: true
          scenario-dependent: false
        - id: e_max_pu
          time-dependent: true
          scenario-dependent: false
        #- id: e_initial #Parameter not instantiated for now
        #- id: e_initial_per_period #Parameter not instantiated for now
        #- id: e_cyclic #Parameter not instantiated for now
        #- id: e_cyclic_per_period #Parameter not instantiated for now
        #- id: p_set #Parameter not instantiated for now
        #- id: q_set #Parameter not instantiated for now
        - id: sign #default value = 1
          time-dependent: false
          scenario-dependent: false
        - id: marginal_cost
          time-dependent: true
          scenario-dependent: false
        #- id: marginal_cost_quadratic #Parameter not instantiated for now
        - id: marginal_cost_storage
          time-dependent: true
          scenario-dependent: false
        #- id: capital_cost #Parameter not instantiated for now
        - id: standing_loss
          time-dependent: true
          scenario-dependent: false
        - id: active
          time-dependent: false
          scenario-dependent: false
        #- id: build_year #Parameter not instantiated for now
        #- id: lifetime #Parameter not instantiated for now
      variables:
        - id: e
          lower-bound: e_min_pu * e_nom
          upper-bound: e_max_pu * e_nom
        - id: p
      ports:
        - id: p_balance_port
          type: flow
      port-field-definitions:
        - port: p_balance_port
          field: flow
          definition: p
      constraints:
        - id: energy_balance
          expression: e = (1 - standing_loss) * e[t-1] - p
      objective: expec(sum(marginal_cost * p + marginal_cost_storage * e))

    #- id: global_constraint_inf_co2
    #  #Model for PyPSA global constraint: https://pypsa.readthedocs.io/en/latest/user-guide/components.html#global-constraint
    #  # Case CO2, <=
    #  parameters:
    #    - id: type
    #      time-dependent: false
    #      scenario-dependent: false
    #    - id: carrier_attribute
    #      time-dependent: false
    #      scenario-dependent: false
    #    - id: sense
    #      time-dependent: false
    #      scenario-dependent: false
    #    - id: constant
    #      time-dependent: false
    #      scenario-dependent: false
    #  ports:
    #    - id: emission_port
    #      type: emission
    #  binding-constraints:
    #    - id: constraint_expression
    #      expression: sum_connections(emission_port.emission) <= constant"""